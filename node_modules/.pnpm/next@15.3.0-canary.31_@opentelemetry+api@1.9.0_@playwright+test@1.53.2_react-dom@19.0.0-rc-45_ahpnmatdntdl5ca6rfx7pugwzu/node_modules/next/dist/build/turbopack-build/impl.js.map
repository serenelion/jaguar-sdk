{"version":3,"sources":["../../../src/build/turbopack-build/impl.ts"],"sourcesContent":["import path from 'path'\nimport { validateTurboNextConfig } from '../../lib/turbopack-warning'\nimport {\n  formatIssue,\n  getTurbopackJsConfig,\n  isPersistentCachingEnabled,\n  isRelevantWarning,\n} from '../../shared/lib/turbopack/utils'\nimport { NextBuildContext } from '../build-context'\nimport { createDefineEnv, loadBindings } from '../swc'\nimport {\n  rawEntrypointsToEntrypoints,\n  handleRouteType,\n} from '../handle-entrypoints'\nimport { TurbopackManifestLoader } from '../../shared/lib/turbopack/manifest-loader'\nimport { promises as fs } from 'fs'\nimport { PHASE_PRODUCTION_BUILD } from '../../shared/lib/constants'\nimport loadConfig from '../../server/config'\nimport { hasCustomExportOutput } from '../../export/utils'\nimport { Telemetry } from '../../telemetry/storage'\nimport { setGlobal } from '../../trace'\nimport { isStableBuild, CanaryOnlyError } from '../../shared/lib/canary-only'\n\nexport async function turbopackBuild(): Promise<{\n  duration: number\n  buildTraceContext: undefined\n  shutdownPromise: Promise<void>\n}> {\n  if (isStableBuild()) {\n    throw new CanaryOnlyError(\n      'Turbopack builds are only available in canary builds of Next.js.'\n    )\n  }\n\n  await validateTurboNextConfig({\n    dir: NextBuildContext.dir!,\n    isDev: false,\n  })\n\n  const config = NextBuildContext.config!\n  const dir = NextBuildContext.dir!\n  const distDir = NextBuildContext.distDir!\n  const buildId = NextBuildContext.buildId!\n  const encryptionKey = NextBuildContext.encryptionKey!\n  const previewProps = NextBuildContext.previewProps!\n  const hasRewrites = NextBuildContext.hasRewrites!\n  const rewrites = NextBuildContext.rewrites!\n  const appDirOnly = NextBuildContext.appDirOnly!\n  const noMangling = NextBuildContext.noMangling!\n\n  const startTime = process.hrtime()\n  const bindings = await loadBindings(config?.experimental?.useWasmBinary)\n  const dev = false\n\n  // const supportedBrowsers = await getSupportedBrowsers(dir, dev)\n  const supportedBrowsers = [\n    'last 1 Chrome versions, last 1 Firefox versions, last 1 Safari versions, last 1 Edge versions',\n  ]\n\n  const persistentCaching = isPersistentCachingEnabled(config)\n  const project = await bindings.turbo.createProject(\n    {\n      projectPath: dir,\n      rootPath:\n        config.experimental?.turbo?.root || config.outputFileTracingRoot || dir,\n      distDir,\n      nextConfig: config,\n      jsConfig: await getTurbopackJsConfig(dir, config),\n      watch: {\n        enable: false,\n      },\n      dev,\n      env: process.env as Record<string, string>,\n      defineEnv: createDefineEnv({\n        isTurbopack: true,\n        clientRouterFilters: NextBuildContext.clientRouterFilters!,\n        config,\n        dev,\n        distDir,\n        fetchCacheKeyPrefix: config.experimental.fetchCacheKeyPrefix,\n        hasRewrites,\n        // Implemented separately in Turbopack, doesn't have to be passed here.\n        middlewareMatchers: undefined,\n      }),\n      buildId,\n      encryptionKey,\n      previewProps,\n      browserslistQuery: supportedBrowsers.join(', '),\n      noMangling,\n    },\n    {\n      persistentCaching,\n      memoryLimit: config.experimental.turbo?.memoryLimit,\n      dependencyTracking: persistentCaching,\n    }\n  )\n\n  await fs.mkdir(path.join(distDir, 'server'), { recursive: true })\n  await fs.mkdir(path.join(distDir, 'static', buildId), {\n    recursive: true,\n  })\n  await fs.writeFile(\n    path.join(distDir, 'package.json'),\n    JSON.stringify(\n      {\n        type: 'commonjs',\n      },\n      null,\n      2\n    )\n  )\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  const entrypoints = await project.writeAllEntrypointsToDisk(appDirOnly)\n\n  const manifestLoader = new TurbopackManifestLoader({\n    buildId,\n    distDir,\n    encryptionKey,\n  })\n\n  const topLevelErrors = []\n  const topLevelWarnings = []\n  for (const issue of entrypoints.issues) {\n    if (issue.severity === 'error' || issue.severity === 'fatal') {\n      topLevelErrors.push(formatIssue(issue))\n    } else if (isRelevantWarning(issue)) {\n      topLevelWarnings.push(formatIssue(issue))\n    }\n  }\n\n  if (topLevelWarnings.length > 0) {\n    console.warn(\n      `Turbopack build encountered ${\n        topLevelWarnings.length\n      } warnings:\\n${topLevelWarnings.join('\\n')}`\n    )\n  }\n\n  if (topLevelErrors.length > 0) {\n    throw new Error(\n      `Turbopack build failed with ${\n        topLevelErrors.length\n      } errors:\\n${topLevelErrors.join('\\n')}`\n    )\n  }\n\n  const currentEntrypoints = await rawEntrypointsToEntrypoints(entrypoints)\n\n  const promises: Promise<any>[] = []\n\n  if (!appDirOnly) {\n    for (const [page, route] of currentEntrypoints.page) {\n      promises.push(\n        handleRouteType({\n          page,\n          route,\n          manifestLoader,\n        })\n      )\n    }\n  }\n\n  for (const [page, route] of currentEntrypoints.app) {\n    promises.push(\n      handleRouteType({\n        page,\n        route,\n        manifestLoader,\n      })\n    )\n  }\n\n  await Promise.all(promises)\n\n  await Promise.all([\n    manifestLoader.loadBuildManifest('_app'),\n    manifestLoader.loadPagesManifest('_app'),\n    manifestLoader.loadFontManifest('_app'),\n    manifestLoader.loadPagesManifest('_document'),\n    manifestLoader.loadBuildManifest('_error'),\n    manifestLoader.loadPagesManifest('_error'),\n    manifestLoader.loadFontManifest('_error'),\n    entrypoints.instrumentation &&\n      manifestLoader.loadMiddlewareManifest(\n        'instrumentation',\n        'instrumentation'\n      ),\n    entrypoints.middleware &&\n      (await manifestLoader.loadMiddlewareManifest('middleware', 'middleware')),\n  ])\n\n  await manifestLoader.writeManifests({\n    devRewrites: undefined,\n    productionRewrites: rewrites,\n    entrypoints: currentEntrypoints,\n  })\n\n  const shutdownPromise = project.shutdown()\n\n  const time = process.hrtime(startTime)\n  return {\n    duration: time[0] + time[1] / 1e9,\n    buildTraceContext: undefined,\n    shutdownPromise,\n  }\n}\n\nlet shutdownPromise: Promise<void> | undefined\nexport async function workerMain(workerData: {\n  buildContext: typeof NextBuildContext\n}): Promise<Awaited<ReturnType<typeof turbopackBuild>>> {\n  // setup new build context from the serialized data passed from the parent\n  Object.assign(NextBuildContext, workerData.buildContext)\n\n  /// load the config because it's not serializable\n  NextBuildContext.config = await loadConfig(\n    PHASE_PRODUCTION_BUILD,\n    NextBuildContext.dir!\n  )\n\n  // Matches handling in build/index.ts\n  // https://github.com/vercel/next.js/blob/84f347fc86f4efc4ec9f13615c215e4b9fb6f8f0/packages/next/src/build/index.ts#L815-L818\n  // Ensures the `config.distDir` option is matched.\n  if (hasCustomExportOutput(NextBuildContext.config)) {\n    NextBuildContext.config.distDir = '.next'\n  }\n\n  // Clone the telemetry for worker\n  const telemetry = new Telemetry({\n    distDir: NextBuildContext.config.distDir,\n  })\n  setGlobal('telemetry', telemetry)\n\n  const result = await turbopackBuild()\n  shutdownPromise = result.shutdownPromise\n  return result\n}\n\nexport async function waitForShutdown(): Promise<void> {\n  if (shutdownPromise) {\n    await shutdownPromise\n  }\n}\n"],"names":["turbopackBuild","waitForShutdown","workerMain","config","isStableBuild","CanaryOnlyError","validateTurboNextConfig","dir","NextBuildContext","isDev","distDir","buildId","encryptionKey","previewProps","hasRewrites","rewrites","appDirOnly","noMangling","startTime","process","hrtime","bindings","loadBindings","experimental","useWasmBinary","dev","supportedBrowsers","persistentCaching","isPersistentCachingEnabled","project","turbo","createProject","projectPath","rootPath","root","outputFileTracingRoot","nextConfig","jsConfig","getTurbopackJsConfig","watch","enable","env","defineEnv","createDefineEnv","isTurbopack","clientRouterFilters","fetchCacheKeyPrefix","middlewareMatchers","undefined","browserslistQuery","join","memoryLimit","dependencyTracking","fs","mkdir","path","recursive","writeFile","JSON","stringify","type","entrypoints","writeAllEntrypointsToDisk","manifestLoader","TurbopackManifestLoader","topLevelErrors","topLevelWarnings","issue","issues","severity","push","formatIssue","isRelevantWarning","length","console","warn","Error","currentEntrypoints","rawEntrypointsToEntrypoints","promises","page","route","handleRouteType","app","Promise","all","loadBuildManifest","loadPagesManifest","loadFontManifest","instrumentation","loadMiddlewareManifest","middleware","writeManifests","devRewrites","productionRewrites","shutdownPromise","shutdown","time","duration","buildTraceContext","workerData","Object","assign","buildContext","loadConfig","PHASE_PRODUCTION_BUILD","hasCustomExportOutput","telemetry","Telemetry","setGlobal","result"],"mappings":"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"}